{% extends 'base.html' %}
{% load static %}

{% block title %}AtomicVerse - Interactive Periodic Table{% endblock %}

{% block content %}
<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="atom-logo">
                <div class="nucleus"></div>
                <div class="orbit orbit1"></div>
                <div class="orbit orbit2"></div>
                <div class="electron"></div>
            </div>
            <h1>AtomicVerse</h1>
        </div>
        <nav>
            <ul>
                <li><a href="{% url 'home' %}" class="active">Periodic Table</a></li>
                <li><a href="{% url 'mnemonics_hub' %}">Mnemonics Hub</a></li>
                <li><a href="{% url 'quizzes' %}">Quizzes</a></li>
                <li><a href="{% url 'profile' %}">My Profile</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search by name, symbol or number...">
                <button id="search-btn">Search</button>
                <button id="clear-search" class="btn-secondary">Clear</button>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <label>Categories:</label>
                    <div class="category-filters">
                        <label><input type="checkbox" value="alkali-metal"> Alkali Metals</label>
                        <label><input type="checkbox" value="alkaline-earth"> Alkaline Earth</label>
                        <label><input type="checkbox" value="transition"> Transition Metals</label>
                        <label><input type="checkbox" value="basic-metal"> Basic Metals</label>
                        <label><input type="checkbox" value="semiconductor"> Semiconductors</label>
                        <label><input type="checkbox" value="non-metal"> Non-metals</label>
                        <label><input type="checkbox" value="halogen"> Halogens</label>
                        <label><input type="checkbox" value="noble-gas"> Noble Gases</label>
                        <label><input type="checkbox" value="lanthanide"> Lanthanides</label>
                        <label><input type="checkbox" value="actinide"> Actinides</label>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="state-filter">State:</label>
                    <select id="state-filter">
                        <option value="all">All States</option>
                        <option value="solid">Solid</option>
                        <option value="liquid">Liquid</option>
                        <option value="gas">Gas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button id="reset-filters" class="btn-secondary">Reset Filters</button>
                </div>
            </div>
        </header>

        <div class="periodic-table-container">
            <div class="periodic-table" id="periodic-table">
                <!-- Periodic table will be generated by JavaScript -->
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <h4>Element Categories:</h4>
            <div class="legend-items">
                <div class="legend-item"><span class="color-box alkali-metal"></span> Alkali Metals</div>
                <div class="legend-item"><span class="color-box alkaline-earth"></span> Alkaline Earth</div>
                <div class="legend-item"><span class="color-box transition"></span> Transition Metals</div>
                <div class="legend-item"><span class="color-box basic-metal"></span> Basic Metals</div>
                <div class="legend-item"><span class="color-box semiconductor"></span> Semiconductors</div>
                <div class="legend-item"><span class="color-box non-metal"></span> Non-metals</div>
                <div class="legend-item"><span class="color-box halogen"></span> Halogens</div>
                <div class="legend-item"><span class="color-box noble-gas"></span> Noble Gases</div>
                <div class="legend-item"><span class="color-box lanthanide"></span> Lanthanides</div>
                <div class="legend-item"><span class="color-box actinide"></span> Actinides</div>
            </div>
        </div>
    </div>
</div>

<!-- Element Details Modal -->
<div id="element-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="element-details">
            <!-- Element details will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
    // Global elements data
    let elements = [];

    // Define all functions first
    function createElementCell(element, container, gridColumn, gridRow) {
        const elementDiv = document.createElement('div');
        elementDiv.className = `element ${element.category}`;
        elementDiv.style.gridColumn = gridColumn;
        elementDiv.style.gridRow = gridRow;
        elementDiv.dataset.number = element.number;
        elementDiv.title = `${element.name} (${element.symbol}) - ${formatCategory(element.category)}`;

        elementDiv.innerHTML = `
            <span class="element-number">${element.number}</span>
            <span class="element-symbol">${element.symbol}</span>
            <span class="element-name">${element.name}</span>
        `;

        elementDiv.addEventListener('click', () => showElementDetails(element));
        container.appendChild(elementDiv);
    }

    function addSpecialElements(category, row, container) {
        const specialElements = elements.filter(el => el.category === category);
        
        // Add label
        const label = document.createElement('div');
        label.className = 'period-label';
        label.textContent = category === 'lanthanide' ? '*' : '**';
        label.title = category === 'lanthanide' ? 'Lanthanides' : 'Actinides';
        label.style.gridColumn = 1;
        label.style.gridRow = row;
        container.appendChild(label);

        // Add elements starting from column 4
        specialElements.forEach((element, index) => {
            createElementCell(element, container, index + 4, row);
        });
    }

    function createPeriodicTable() {
        const container = document.getElementById('periodic-table');
        if (!container) {
            console.error('Periodic table container not found');
            return;
        }

        console.log('Creating periodic table with', elements.length, 'elements');
        container.innerHTML = '';

        // Add group labels (top row)
        for (let group = 1; group <= 18; group++) {
            const label = document.createElement('div');
            label.className = 'group-label';
            label.textContent = group;
            label.style.gridColumn = group + 1;
            label.style.gridRow = 1;
            container.appendChild(label);
        }

        // Add period labels and main table elements
        for (let period = 1; period <= 7; period++) {
            // Add period label
            const periodLabel = document.createElement('div');
            periodLabel.className = 'period-label';
            periodLabel.textContent = period;
            periodLabel.style.gridColumn = 1;
            periodLabel.style.gridRow = period + 1;
            container.appendChild(periodLabel);

            // Add elements for this period
            for (let group = 1; group <= 18; group++) {
                const element = elements.find(el => 
                    el.period === period && el.group === group && 
                    el.category !== 'lanthanide' && el.category !== 'actinide'
                );
                
                if (element) {
                    createElementCell(element, container, group + 1, period + 1);
                } else {
                    // Create empty cell for proper grid spacing
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'empty-cell';
                    emptyCell.style.gridColumn = group + 1;
                    emptyCell.style.gridRow = period + 1;
                    container.appendChild(emptyCell);
                }
            }
        }

        // Add lanthanides (row 9)
        addSpecialElements('lanthanide', 9, container);
        
        // Add actinides (row 10)  
        addSpecialElements('actinide', 10, container);

        console.log('Periodic table created successfully');
    }

    function showElementDetails(element) {
        const modal = document.getElementById('element-modal');
        const detailsContainer = document.getElementById('element-details');
        
        if (!modal || !detailsContainer) return;

        detailsContainer.innerHTML = `
            <h3>
                <span style="background: inherit; padding: 8px 15px; border-radius: 8px; border: 2px solid currentColor;">
                    ${element.symbol}
                </span>
                ${element.name}
            </h3>
            <div class="element-detail"><span>Atomic Number:</span><span>${element.number}</span></div>
            <div class="element-detail"><span>Atomic Weight:</span><span>${element.atomicWeight}</span></div>
            <div class="element-detail"><span>Category:</span><span>${formatCategory(element.category)}</span></div>
            <div class="element-detail"><span>State at Room Temperature:</span><span>${formatState(element.state)}</span></div>
            <div class="element-detail"><span>Melting Point:</span><span>${element.meltingPoint}°C</span></div>
            <div class="element-detail"><span>Boiling Point:</span><span>${element.boilingPoint}°C</span></div>
            <div class="element-detail"><span>Electronic Configuration:</span><span>${element.electronicConfig}</span></div>
            <div class="element-detail"><span>Discovered By:</span><span>${element.discoveredBy}</span></div>
            <div class="element-detail"><span>Group:</span><span>${element.group}</span></div>
            <div class="element-detail"><span>Period:</span><span>${element.period}</span></div>
        `;

        modal.style.display = 'block';
    }

    function formatCategory(category) {
        const categoryMap = {
            'alkali-metal': 'Alkali Metal',
            'alkaline-earth': 'Alkaline Earth Metal',
            'transition': 'Transition Metal',
            'basic-metal': 'Basic Metal',
            'semiconductor': 'Semiconductor',
            'non-metal': 'Non-metal',
            'halogen': 'Halogen',
            'noble-gas': 'Noble Gas',
            'lanthanide': 'Lanthanide',
            'actinide': 'Actinide'
        };
        return categoryMap[category] || category;
    }

    function formatState(state) {
        const stateMap = {
            'solid': 'Solid',
            'liquid': 'Liquid',
            'gas': 'Gas'
        };
        return stateMap[state] || state;
    }

    function handleSearch() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        
        if (!searchTerm) {
            clearSearch();
            return;
        }

        const matchingElements = elements.filter(element => 
            element.name.toLowerCase().includes(searchTerm) ||
            element.symbol.toLowerCase().includes(searchTerm) ||
            element.number.toString().includes(searchTerm)
        );

        // Remove previous highlights
        document.querySelectorAll('.element').forEach(el => {
            el.classList.remove('highlighted');
        });

        // Highlight matching elements
        matchingElements.forEach(element => {
            const elementDiv = document.querySelector(`.element[data-number="${element.number}"]`);
            if (elementDiv) {
                elementDiv.classList.add('highlighted');
                // Scroll to first matching element
                if (matchingElements[0] === element) {
                    elementDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        if (matchingElements.length === 0) {
            alert('No elements found matching your search.');
        }
    }

    function clearSearch() {
        document.getElementById('search-input').value = '';
        document.querySelectorAll('.element').forEach(el => {
            el.classList.remove('highlighted');
        });
    }

    function applyFilters() {
        const selectedCategories = Array.from(document.querySelectorAll('.category-filters input:checked'))
            .map(checkbox => checkbox.value);
        
        const stateFilter = document.getElementById('state-filter').value;
        
        document.querySelectorAll('.element').forEach(el => {
            const elementNumber = parseInt(el.dataset.number);
            const element = elements.find(e => e.number === elementNumber);
            
            if (!element) return;
            
            const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(element.category);
            const stateMatch = stateFilter === 'all' || element.state === stateFilter;
            
            if (categoryMatch && stateMatch) {
                el.style.display = 'flex';
                el.style.opacity = '1';
            } else {
                el.style.display = 'flex';
                el.style.opacity = '0.3';
            }
        });
    }

    function handleCategoryFilter() {
        applyFilters();
    }

    function handleStateFilter() {
        applyFilters();
    }

    function resetFilters() {
        // Uncheck all category checkboxes
        document.querySelectorAll('.category-filters input').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Reset state filter
        document.getElementById('state-filter').value = 'all';
        
        // Clear search
        clearSearch();
        
        // Reset all elements to full visibility
        document.querySelectorAll('.element').forEach(el => {
            el.style.display = 'flex';
            el.style.opacity = '1';
            el.classList.remove('highlighted');
        });
    }

    function initializeEventListeners() {
        // Search functionality
        document.getElementById('search-btn').addEventListener('click', handleSearch);
        document.getElementById('clear-search').addEventListener('click', clearSearch);
        document.getElementById('search-input').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') handleSearch();
        });

        // Filter functionality
        document.querySelectorAll('.category-filters input').forEach(checkbox => {
            checkbox.addEventListener('change', handleCategoryFilter);
        });
        document.getElementById('state-filter').addEventListener('change', handleStateFilter);
        document.getElementById('reset-filters').addEventListener('click', resetFilters);

        // Modal close functionality
        document.querySelector('.close').addEventListener('click', function() {
            document.getElementById('element-modal').style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('element-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // Main initialization - Load elements when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Loading periodic table...');
        
        // Load elements from JSON file
        fetch("{% static 'data/elements.json' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load elements.json - Status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                elements = data.elements;
                console.log('Successfully loaded', elements.length, 'elements');
                createPeriodicTable();
                initializeEventListeners();
            })
            .catch(error => {
                console.error('Error loading elements:', error);
                // Show error message
                const container = document.getElementById('periodic-table');
                if (container) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--danger);">
                            <h3>Error Loading Periodic Table</h3>
                            <p>${error.message}</p>
                            <p>Please check that elements.json exists in static/data/</p>
                            <p>Check browser console for details</p>
                        </div>
                    `;
                }
            });
    });
</script>
{% endblock %}