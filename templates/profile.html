{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - AtomicVerse{% endblock %}

{% block content %}
<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="atom-logo">
                <div class="nucleus"></div>
                <div class="orbit orbit1"></div>
                <div class="orbit orbit2"></div>
                <div class="electron"></div>
            </div>
            <h1>AtomicVerse</h1>
        </div>
        <nav>
            <ul>
                <li><a href="{% url 'home' %}">Periodic Table</a></li>
                <li><a href="{% url 'mnemonics_hub' %}">Mnemonics Hub</a></li>
                <li><a href="{% url 'quizzes' %}">Quizzes</a></li>
                <li><a href="{% url 'profile' %}" class="active">My Profile</a></li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-content">
            <h2>My Profile</h2>
            
            {% if not user.is_authenticated %}
            <!-- Login/Signup Form -->
            <div id="auth-forms">
                <div class="auth-tabs">
                    <button class="tab-btn active" data-tab="login">üîê Login</button>
                    <button class="tab-btn" data-tab="signup">üöÄ Sign Up</button>
                </div>
                
                <div id="login-form" class="auth-form active">
                    <form method="POST" action="{% url 'login' %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="username">üë§ Username:</label>
                            <input type="text" id="username" name="username" required placeholder="Enter your username">
                        </div>
                        <div class="form-group">
                            <label for="password">üîí Password:</label>
                            <input type="password" id="password" name="password" required placeholder="Enter your password">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Login to AtomicVerse</button>
                    </form>
                    <div style="text-align: center; margin-top: 15px;">
                        <p style="color: var(--text-light); font-size: 0.9rem;">
                            New here? <a href="javascript:void(0)" onclick="switchAuthTab('signup')" style="color: var(--secondary); text-decoration: none;">Create an account</a>
                        </p>
                    </div>
                </div>
                
                <div id="signup-form" class="auth-form">
                    <form method="POST" action="{% url 'register' %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="signup-username">üë§ Username:</label>
                            <input type="text" id="signup-username" name="username" required placeholder="Choose a username">
                        </div>
                        <div class="form-group">
                            <label for="signup-email">üìß Email:</label>
                            <input type="email" id="signup-email" name="email" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label for="signup-password">üîí Password:</label>
                            <input type="password" id="signup-password" name="password" required placeholder="Create a password">
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">‚úÖ Confirm Password:</label>
                            <input type="password" id="confirm-password" name="confirm_password" required placeholder="Confirm your password">
                        </div>
                        <button type="submit" class="btn-primary" style="width: 100%;">Create Account</button>
                    </form>
                    <div style="text-align: center; margin-top: 15px;">
                        <p style="color: var(--text-light); font-size: 0.9rem;">
                            Already have an account? <a href="javascript:void(0)" onclick="switchAuthTab('login')" style="color: var(--secondary); text-decoration: none;">Login here</a>
                        </p>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- User Profile -->
            <div id="user-profile">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <div class="avatar-circle">
                            <span id="avatar-initials">{{ user.username.0|upper }}</span>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h3 id="profile-name">{{ user.username }}</h3>
                        <p id="profile-email">{{ user.email|default:"No email provided" }}</p>
                        <p class="member-since">Member since: {{ user.date_joined|date:"F Y" }}</p>
                        <form method="POST" action="{% url 'logout' %}" style="margin-top: 15px;">
                            {% csrf_token %}
                            <button type="submit" class="btn-secondary">üö™ Logout</button>
                        </form>
                    </div>
                </div>
                
                <div class="profile-sections">
                    <div class="profile-section">
                        <h3>üìä Quiz History</h3>
                        <div id="quiz-history">
                            {% if user_scores %}
                                {% for score in user_scores %}
                                <div class="quiz-history-item">
                                    <div class="quiz-info">
                                        <span class="quiz-level">{{ score.get_level_display }}</span>
                                        <span class="quiz-score">{{ score.score }}/{{ score.total_questions }}</span>
                                    </div>
                                    <div class="quiz-meta">
                                        <span class="quiz-date">{{ score.completed_at|date:"M d, Y" }}</span>
                                        <span class="quiz-time">{{ score.time_taken }}s</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <p>No quiz attempts yet.</p>
                                    <a href="{% url 'quizzes' %}" class="btn-primary" style="margin-top: 10px; display: inline-block;">Take Your First Quiz</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>üìù My Mnemonics</h3>
                        <div id="user-mnemonics">
                            {% if user_mnemonics %}
                                {% for mnemonic in user_mnemonics %}
                                <div class="mnemonic-item">
                                    <div class="mnemonic-preview">
                                        <strong>{{ mnemonic.title }}</strong>
                                        <span class="mnemonic-likes">‚ù§Ô∏è {{ mnemonic.like_count }} likes</span>
                                    </div>
                                    <span class="mnemonic-date">{{ mnemonic.created_at|date:"M d, Y" }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <p>No mnemonics created yet.</p>
                                    <a href="{% url 'mnemonics_hub' %}" class="btn-primary" style="margin-top: 10px; display: inline-block;">Create Your First Mnemonic</a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>üèÜ Leaderboard</h3>
                        <div id="leaderboard">
                            {% if leaderboard %}
                                {% for entry in leaderboard %}
                                <div class="leaderboard-item {% if entry.user == user %}current-user{% endif %}">
                                    <div class="leaderboard-rank">
                                        <span class="rank-number">{{ forloop.counter }}</span>
                                        <span class="rank-user">{{ entry.user.username }}{% if entry.user == user %} (You){% endif %}</span>
                                    </div>
                                    <div class="leaderboard-score">
                                        <span class="average-score">Avg: {{ entry.average_score|floatformat:1 }}</span>
                                        <span class="quiz-count">{{ entry.quiz_count }} quizzes</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <p>Complete quizzes to appear on the leaderboard!</p>
                                    <p style="font-size: 0.9rem; margin-top: 5px;">The more you play, the higher you rank! üöÄ</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-info">
                            <span class="stat-number">{{ user_scores|length }}</span>
                            <span class="stat-label">Quizzes Taken</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-info">
                            <span class="stat-number">{{ user_mnemonics|length }}</span>
                            <span class="stat-label">Mnemonics Created</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ù§Ô∏è</div>
                        <div class="stat-info">
                            <span class="stat-number">
                                {% with total_likes=0 %}
                                    {% for mnemonic in user_mnemonics %}
                                        {% widthratio mnemonic.like_count 1 1 as mnemonic_likes %}
                                        {{ total_likes|add:mnemonic_likes }}
                                    {% endfor %}
                                    {{ total_likes|default:"0" }}
                                {% endwith %}
                            </span>
                            <span class="stat-label">Total Likes</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function switchAuthTab(tab) {
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.classList.toggle('active', button.dataset.tab === tab);
        });
        
        // Show corresponding form
        document.querySelectorAll('.auth-form').forEach(form => {
            form.classList.toggle('active', form.id === `${tab}-form`);
        });
    }

    // Initialize tab functionality
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tab = this.dataset.tab;
            switchAuthTab(tab);
        });
    });

    // Password confirmation validation
    const signupForm = document.getElementById('signup-form');
    if (signupForm) {
        signupForm.addEventListener('submit', function(e) {
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                alert('Passwords do not match! Please check your password confirmation.');
                return false;
            }
            
            if (password.length < 6) {
                e.preventDefault();
                alert('Password should be at least 6 characters long.');
                return false;
            }
        });
    }
</script>

<style>
    .member-since {
        color: var(--text-light);
        font-size: 0.9rem;
        margin-top: 5px;
    }
    
    .quiz-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .quiz-level {
        font-weight: 600;
        color: var(--secondary);
    }
    
    .quiz-score {
        font-size: 1.1rem;
        font-weight: bold;
    }
    
    .quiz-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 3px;
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    .mnemonic-preview {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .mnemonic-likes {
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    .leaderboard-rank {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .rank-number {
        background: var(--secondary);
        color: white;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .leaderboard-score {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 3px;
        font-size: 0.85rem;
    }
    
    .average-score {
        font-weight: 600;
        color: var(--secondary);
    }
    
    .quiz-count {
        color: var(--text-light);
    }
    
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
        padding: 20px;
        background: var(--surface);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }
    
    .stat-card {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        background: linear-gradient(135deg, var(--pastel-blue), var(--primary));
        border-radius: var(--border-radius);
        color: white;
    }
    
    .stat-icon {
        font-size: 2rem;
    }
    
    .stat-info {
        display: flex;
        flex-direction: column;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        line-height: 1;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}